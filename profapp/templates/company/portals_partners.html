{% extends "index_lazy_layout.html" %}

{% block title %}Profireader{% endblock title %}

{% block head %}
    {{ super() }}
    {% include '_ruslan/partials/_header_files_grid.html' %}
{% endblock head %}

{% block portal_content %}
    {% block company_base %}
        {% include 'company/company_base_angular.html' %}
    {% endblock company_base %}

    {% raw %}

    <script type="text/ng-template" id="request_membership_plan.html">
        <div class="SelectMembershipPlanController_class"
             af ng-model="data" af-after-save="afterSave" af-url="{{ url_request_membership_plan() }}">
            <div class="modal-header">
                <h3 class="modal-title">{{ ::_('please select desired plan') }}</h3>
                <h4>{{ __('for company `%(data.membership.company.name)s` in portal `%(data.membership.portal.name)s`')
                    }}</h4>
            </div>

            <div class="modal-body">

                <table>
                    <tr>
                        <th class="border-none" colspan="7"><h5>{{ ::_('current active plan') }}</h5></th>
                    </tr>

                    <tr ng-if="!data.membership.membership_plan_used">
                        <td class="border-none" colspan="7"><em>{{ ::_('Your membership running now without any plan')
                            }}</em>
                            <hr/>
                        </td>
                    </tr>

                    <tr ng-if="data.membership.membership_plan_used">
                        <td class="border-none" colspan="7"><h5>{{data.membership.membership_plan_used }}</h5>
                            <hr/>
                        </td>
                    </tr>

                    <tbody ng-if="data.membership.requested_membership_plan">
                    <tr>
                        <th class="border-none" colspan="7"><h5>{{ ::_('Your request following plan. This plan
                            was not yet confirmed by portal owner') }}</h5>
                        </th>
                    </tr>
                    <tr>
                        <td></td>
                        <td>{{ data.membership.requested_membership_plan.name }}</td>
                        <td>{{ data.membership.requested_membership_plan.price }} {{
                            data.membership.requested_membership_plan.currency_id }}
                        </td>
                        <td>{{ data.membership.requested_membership_plan.duration }}</td>
                        <td class="w1em">{{ publication_count(data.membership.requested_membership_plan, 'open') }}</td>
                        <td class="w1em">{{ publication_count(data.membership.requested_membership_plan, 'registered')
                            }}
                        </td>
                        <td class="w1em">{{ publication_count(data.membership.requested_membership_plan, 'payed') }}
                        </td>
                    </tr>
                    </tbody>

                    <tr ng-if="data.membership.requested_membership_plan">
                        <td class="border-none" colspan="7">
                            <hr/>
                        </td>
                    </tr>


                    <tr>
                        <th class="border-none" colspan="7"><h5>{{ ::_('please select membership plan') }}</h5></th>
                    </tr>

                    <tr ng-if="!data.select.plans.length">
                        <th class="border-none error" colspan="7"><h5>{{ ::_('Sorry there is no plan in this portal')
                            }}</h5></th>
                    </tr>
                    <tbody ng-if="data.select.plans.length">
                    <tr>
                        <td rowspan="2"></td>
                        <th rowspan="2">{{ ::_('Plan name') }}</th>
                        <th rowspan="2">{{ ::_('Plan price') }}</th>
                        <th rowspan="2">{{ ::_('Plan duration') }}</th>
                        <th colspan="3" class="nowrap">{{ ::_('Publication count') }}</th>
                    </tr>

                    <tr>
                        <th>{{ ::_('open') }}</th>
                        <th>{{ ::_('registered') }}</th>
                        <th>{{ ::_('payed') }}</th>
                    </tr>

                    <tr class="link" ng-click="data.selected_by_user_plan_id = plan.id"
                        ng-repeat="plan in data.select.plans">
                        <td class="tac">
                            <div pr-validation-answer="data_validation:selected_by_user_plan_id"><input
                                    ng-value="plan.id" type="radio" ng-model="data.selected_by_user_plan_id"/></div>
                        </td>
                        <td>{{ plan.name }}</td>
                        <td>{{ plan.price }} {{ plan.currency_id }}</td>
                        <td>{{ plan.duration }}</td>
                        <td class="w1em">{{ publication_count(plan, 'open') }}</td>
                        <td class="w1em">{{ publication_count(plan, 'registered') }}</td>
                        <td class="w1em">{{ publication_count(plan, 'payed') }}</td>
                    </tr>
                    </tbody>
                </table>


            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" type="button"
                        ng-click="$af.save(data)" ng-disabled="!$af.isActionAllowed(data, 'save') ">
                    {{ ::_('Select plan') }}
                </button>
                <button class="btn btn-warning" type="button" ng-click="cancel()">{{ _('Cancel') }}</button>
            </div>
        </div>
    </script>
    {% endraw %}

    <script>

        module.controller('RequestMembershipPlanController', function ($scope, $ok, $uibModalInstance, membership_id) {

            $scope.$$translate = {{ translates('RequestMembershipPlanController')|safe }};

            $scope.url_request_membership_plan = {{ raw_url_for('portal.request_membership_plan')|safe }};
            $scope.membership_id = membership_id;

            $scope.afterSave = function (resp) {
                $uibModalInstance.close(resp)
            };

            $scope.publication_count = function (plan, pub_type) {
                var ret = plan['publication_count_' + pub_type];
                return ret < 0 ? 'unlimited' : (ret ? ret : '0');
            };

            $scope.cancel = $uibModalInstance.dismiss;

        });

        module.controller('portals_partners', function ($scope, $ok, $sce, $membership_tags, $uibModal) {
            angularControllerFunction('CompanyMenuController', 'set_selected_company_menu')('portals_partners');
            $scope.$$translate = {{ translates('portals_partners')|safe }};
            $scope.url_portals_partners = '{{ url_for('portal.portals_partners', company_id=company.id)}}';
            $scope.company_id = '{{ company.id|safe }}';
            $scope.url_search_for_portal = function () {
                return ( '/portal/search_for_portal_to_join/' );
            };
            $scope.url_change_status = {{ raw_url_for('portal.portals_partners_change_status')|safe }};
            $scope.url_join = {{ raw_url_for('portal.apply_company')|safe }};
            $scope.url_company_profile = {{ raw_url_for('company.profile')|safe }};
            $scope.selectedPortal_name = '';
            $scope.selectedPortal = null;
            $scope.selectedPortal_sending = false;
            $scope.actions = {{ actions|safe }}

                    {% raw %}

                    $scope.onSelect = function ($item, $model, $label) {
                        if (!$item || !$item.id) {
                            $scope.selectedPortal_name = '';
                            $scope.selectedPortal = null;
                        }
                        else {
                            $scope.selectedPortal = $item;
                        }
                    };

            $scope.searchForPortalToJoin = function (val) {
                return $ok($scope.url_search_for_portal(), {
                    company_id: $scope.company_id,
                    search: val
                }, function (resp) {
                    return resp.length ? resp : [{id: false, name: 'No results'}];
                });
            };

            $scope.joinToPortal = function () {
                return $ok($scope.url_join({company_id: $scope.company_id}), {
                    portal_id: $scope.selectedPortal.id
                }, function () {
                    $scope.gridApi.grid.setGridData();
                    $scope.selectedPortal = null;
                    $scope.selectedPortal_name = null;
                }).finally(function () {
                    delete $scope.all_grid_data['paginationOptions']['page_for_id'];
                    $scope.selectedPortal_sending = false;
                })
            };

            $scope.grid_action = function (id, action, row, column_name) {
                return $ok($scope.url_change_status({
                    company_id: $scope.company_id,
                    portal_id: row.portal.id
                }), {action: action, who: row.who, partner_id: $scope.company_id}, function (resp) {
                    $scope.gridApi.grid.grid_change_row(resp)
                }).finally(function () {
                })
            };

            $scope.portal_link = function (link) {
                return 'http://' + link;
            };

            $scope.set_tags = function (id, row, name) {

                var modalInstance = $membership_tags({
                    company_id: $scope.company_id,
                    portal_id: row['portal']['id']
                });

                modalInstance.result.then(function (updated_row) {
                    // TODO: scope.data is not defined! loaded data exists ONLY in grid data. yes?
                    $scope.gridApi.grid.grid_change_row(updated_row['membership']);
                });

            };

            $scope.request_membership_plan = function (id, row, column_name) {
                var modalInstance = $uibModal.open({
                    templateUrl: 'request_membership_plan.html',
                    controller: 'RequestMembershipPlanController',
                    resolve: resolveDictForAngularController({
                        membership_id: row['id']
                    })
                });
                modalInstance.result.then(function (resp) {
                    $scope.gridApi.grid.grid_change_row(resp);
                });
            };

            $scope.gridOptions1 = $.extend({}, $scope.gridOptions, {
                urlLoadGridData: $scope.url_portals_partners,
                columnDefs: [
                    {
                        name: 'portal.name', type: 'link',
                        href: 'portal_link(row.entity.portal.host)', img_url: 'portal.logo.url', link: true
                    },
                    {
                        name: 'portal.own_company.name',
                        type: 'link',
                        href: 'url_company_profile({company_id: row.entity.portal.own_company.id})',
                        img_url: "portal.own_company.logo.url"
                    },
                    {
                        name: 'membership_plan',
                        onclick: 'request_membership_plan',
                        render: function (row, value) {
                            return (row['membership_plan_used'] ? row['membership_plan_used']['name'] : '<i>None</i>') +
                                    (row['requested_membership_plan'] ? (' (<em>' + row['requested_membership_plan']['name'] + '</em>)') : '');
                        }
                    },
                    {
                        name: 'tags', type: 'tags', onclick: 'set_tags'
                    },
                    {
                        name: 'status', width: '20%', afilter: {type: 'multi_select', default_selected: true}
                        //we can default select all and deselect that we need, 'exception' can be string or array of string
                    },
                    {name: 'rights', width: '200', type: 'icons', afilter: {type: 'input'}},
                    {name: 'actions', type: 'actions', onclick: 'grid_action'}
                ]
            });
            {% endraw %}
        })
    </script>

    {% raw %}
    <div ng-controller="portals_partners" ng-cloak>
        <h5> {{ _('Join to portal') }} </h5>
        <input pr-user-can="actions.require_memberee" typeahead-on-select="onSelect($item, $model, $label)"
               uib-typeahead-template-url="typeaheadTemplate.html"
               uib-typeahead-loading="loadingPortals"
               ng-model="selectedPortal_name"
               uib-typeahead="portal as portal.name for portal in searchForPortalToJoin($viewValue)"
               name="portal_id"/>&nbsp;
        <button pr-user-can="actions.require_memberee" class="btn" ng-click="joinToPortal()"
                ng-class="{'disabled': !selectedPortal || selectedPortal_sending}"
                ng-disabled="!selectedPortal || selectedPortal_sending">{{ _('join to this portal') }}
        </button>
        <i ng-show="loadingPortals" class="glyphicon glyphicon-refresh"></i>

        <div class="grid" id="grid1" ui-grid-pagination ui-grid="gridOptions1">
            <div class="well grid-loading" ng-show="loading">
                <i class="fa fa-spinner fa-spin"></i>
                <div>{{ _('Data Loading...') }}</div>
            </div>
        </div>
    </div>
    {% endraw %}
{% endblock portal_content %}
