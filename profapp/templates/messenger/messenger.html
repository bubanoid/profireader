{% extends "index_lazy_layout.html" %}

{% block title %}{{ _('Messages') }}{% endblock title %}

{% block head %}
    {{ super() }}
    {% include '_ruslan/partials/_header_files_infinite-scroll.html' %}
{% endblock head %}

{% block portal_content %}

    <script>
        module.controller('messenger', ['$scope', '$ok', '$sce', '$timeout', function ($scope, $ok, $sce, $timeout) {

            angularControllerFunction('user_controller', 'set_selected_user_menu')('messages');

            $scope.community_search_url = {{ raw_url_for('messenger.community_search')|safe }};
            $scope.contacts_search_url = {{ raw_url_for('messenger.contacts_search')|safe }};
            $scope.contact_action_url = {{ raw_url_for('messenger.contact_action')|safe }};


            $scope.$$translate = {{ translates('messenger')|safe }};
            $scope.selected_messenger_menu = '';
            $scope.me_user = {{ g.user.get_client_side_dict(fields = 'id,avatar,full_name')|tojson }};


            $scope.selected_chat_room = null;
            $scope.loaded_chats = {};


            $scope.community_search_text = '';
            $scope.community = [];
            $scope.community_next_page = 1;
            $scope.community_loading = false;

            $scope.contacts_search_text = '';
            $scope.contacts = [];
            $scope.contacts_next_page = 1;
            $scope.contacts_loading = false;
            $scope.total_unread_message_count = {{ g.user.get_unread_message_count(g.user.id) }};
            $scope.contacts_unread_messages_in_unloaded_contacts_count = 0;


            $scope.set_selected_menu = function (selected) {
                if (selected === $scope.selected_messenger_menu) {
                    return false;
                }
                $scope.selected_messenger_menu = selected;

                if (selected === 'community') {
                    $scope.search_community(true);
                }

                if (selected === 'chat') {
                    $scope.search_contacts(true);
                }

            };

            $scope.get_chat_interlocutors = function (chat, message) {
                return (message && message['from_user_id'] === $scope.me_user['id']) ? $scope.me_user : chat['users'][0];
            };


            $scope.onscroll = function () {

            };

            $scope.restore_old_scroll_position = function () {
                $('#panel-scroll-chat ul').css({'visibility': 'hidden'});
                setTimeout(function () {
                    $('#panel-scroll-chat ul').css({'visibility': ''});
                    if ($scope.selected_chat_room && $scope.selected_chat_room['scroll_position'] > 0) {
                        $('#panel-scroll-chat').scrollTop($scope.selected_chat_room['scroll_position']);
                    }
                }, 0);
            };


            $scope.stickToBottom = function (chatroom_id, fromserver, force, sticktotop, instant) {

                $('#panel-scroll-chat').finish();
                $scope.onscroll = function () {
                    if ($scope.selected_chat_room) {
                        $scope.selected_chat_room['scroll_position'] = $('#panel-scroll-chat')[0].scrollTop;
                    }
                };

                if ((!fromserver || !fromserver['messages'] || !fromserver['messages'].length)) {
                    return false
                }

                var $elementold = $('#panel-scroll-chat');
                var old_max_scroll = $elementold.length ? ($('ul', $elementold).outerHeight() - $elementold.height()) : 0;

                setTimeout(function () {
                    var $element = $('#panel-scroll-chat');
                    var max_scroll = $('ul', $element).outerHeight() - $element.height();

                    if (sticktotop && ($element[0].scrollTop < 10)) {
                        if (instant) {
                            $element.scrollTop(0);
                        }
                        else {
                            $element.animate({scrollTop: 0}, 250);
                        }
                    }
                    else if (!sticktotop && ($element[0].scrollTop > old_max_scroll - 10)) {
                        if (instant) {
                            $element.scrollTop(max_scroll);
                        }
                        else {
                            $element.animate({scrollTop: max_scroll}, 250);
                        }
                    }
                }, 0);
            };

            $scope.add_new_message = function (chat_room_id, message, index, is_new_session) {

                var existing_messages = $scope.loaded_chats[chat_room_id]['messages'];

                var is_first_message_in_session = function (ind) {
                    return ind === 0 || existing_messages[ind]['timestamp'] - existing_messages[ind - 1]['timestamp'] > 3600;
                };

                message['cr_tm'] = $scope.moment(message['cr_tm']);


                if (index >= existing_messages.length - 1) {
                    existing_messages.push(message);
                }
                else if (index == 0) {
                    existing_messages.unshift(message);
                }
                else {
                    console.log('splice!!', index, existing_messages.length);
                    existing_messages.splice(index, 0, message);
                }

                if (is_first_message_in_session(index)) {
                    existing_messages[index]['session'] = true;
                }
                if (index > 0 && existing_messages[index - 1]['session'] && is_first_message_in_session(index)) {
                    existing_messages[index - 1]['session'] = false;
                }
                if (index < existing_messages.length - 1 && existing_messages[index + 1]['session'] && is_first_message_in_session(index + 1)) {
                    existing_messages[index + 1]['session'] = false;
                    ;
                }

            };

            $scope.append_messages = function (chat_room_id, messages) {

                var current_chat = $scope.loaded_chats[chat_room_id];
                if (!current_chat) return;

                var existing_messages = $scope.loaded_chats[chat_room_id]['messages'];
                $.each(messages, function (message_index, message) {
                    if (!existing_messages.length) {
                        $scope.add_new_message(chat_room_id, message, 0);
                    }
                    else if (existing_messages[0]['id'] > message['id']) {
                        $scope.add_new_message(chat_room_id, message, 0);
                    }
                    else if (existing_messages[existing_messages.length - 1]['id'] < message['id']) {
                        $scope.add_new_message(chat_room_id, message, existing_messages.length);
                    }
                    else {
                        for (var i = 0; i < existing_messages.length - 1; i++) {
                            if (existing_messages[i]['id'] < message['id'] && existing_messages[i + 1]['id'] > message['id']) {
                                $scope.add_new_message(chat_room_id, message, i + 1);
                            }
                        }
                    }
                });
            };


            $scope.update_chat_room = function (chat_room_id, chat_room, force, stick_to_top, instant) {
                if ("there_is_older" in chat_room) $scope.loaded_chats[chat_room_id]['there_is_older'] = chat_room['there_is_older'];
                if ("there_is_newer" in chat_room) $scope.loaded_chats[chat_room_id]['there_is_newer'] = chat_room['there_is_newer'];

                if (chat_room['messages'] && chat_room['messages'].length) {
                    $scope.append_messages(chat_room_id, chat_room['messages']);
                    if ($scope.selected_chat_room['chat_room_id'] === chat_room_id) {
                        $scope.stickToBottom(chat_room_id, chat_room, force, stick_to_top, instant);
                    }
                }
            };


            $scope.load_messages = function (older, instant) {

                if (!$scope.selected_chat_room) return false;

                var loadvar = older ? 'loading_older_messages' : 'loading_newer_messages';
                if ($scope.selected_chat_room[loadvar]) return false;

                var loaded_messages_chatr_room_id = $scope.selected_chat_room['chat_room_id'];

                $scope.selected_chat_room[loadvar] = true;
                var data = {'chat_room_id': loaded_messages_chatr_room_id, 'older': older ? true : false};

                data[older ? 'first_message_id' : 'last_message_id'] =
                        $scope.get_last_message_id(loaded_messages_chatr_room_id, older ? true : false);


                pr_chat_socket.emit('load_messages', data, function (resp) {
                    if ($scope.loaded_chats[loaded_messages_chatr_room_id]) {
                        $scope.loaded_chats[loaded_messages_chatr_room_id][loadvar] = false;
                        $scope.update_chat_room(loaded_messages_chatr_room_id, resp, true,
                                    older ? true : false, instant);
                        $scope.$digest();
{#                        $timeout(function () {#}
{#                            #}
{#                        }, 0);#}
                    }
                });

            };


            $scope.select_chat_room = function (chat_room) {

                if ((!$scope.selected_chat_room && !chat_room) ||
                        $scope.selected_chat_room && chat_room && chat_room['chat_room_id'] === $scope.selected_chat_room['chat_room_id']) { // chat_room is loaded
                    return false;
                }
                else {
                    if (chat_room) {
                        if (!$scope.loaded_chats[chat_room['chat_room_id']]) {
                            $scope.loaded_chats[chat_room['chat_room_id']] = {
                                'last_view_tm': now(),
                                'my_message': '',
                                'users': chat_room['users'],
                                'scroll_position': -1,
                                'chat_room_id': chat_room['chat_room_id'],
                                'chat_room_status': chat_room['chat_room_status'],
                                'messages': []
                            };
                            $scope.remove_oldest_loaded_chat();
                        }
                        $scope.selected_chat_room = $scope.loaded_chats[chat_room['chat_room_id']];
                        $scope.restore_old_scroll_position();
                        $scope.load_messages(false, true);
                    }
                    pr_chat_socket.emit('select_chat_room_id', chat_room ? chat_room['chat_room_id'] : null);
                }
            };

{#            $scope.textarea_focus = function () {#}
{#                setTimeout(function () {#}
{#                    $('#messenger-controller #btn-input').focus();#}
{#                }, 0);#}
{#            };#}

            $scope.send_message = function () {
                if ($scope.message_cant_be_sent()) {
                    return false;
                }
                $scope.selected_chat_room['sending_message'] = true;
                pr_chat_socket.emit('send_message', $scope.selected_chat_room['my_message']);
{#                $timeout(function () {#}
                    $scope.selected_chat_room['my_message'] = '';
                    $scope.selected_chat_room['sending_message'] = false;
{#                }, 0);#}
            };


            $scope.remove_oldest_loaded_chat = function () {
                //TODO
                return;
                var loaded_chats_for_users = Object.keys($scope.loaded_chats);
                if (loaded_chats_for_users.length > 19) {
                    var longest_not_viewed = rockets.reduce(function (id_and_last_view_tm, elem) {
                        return timestamp_and_id[0] > elem['last_view'] ? [elem['user']['id'], elem['last_view']] : id_and_last_view_tm;
                    }, [null, now()]);
                    delete $scope.loaded_chats[longest_not_viewed[0]];
                }
            };


            $scope.set_unread_message_count = function (from_server) {

                $.each(from_server, function (chat_room_id, unread_messages_count) {
                    var found = $scope.contacts.find(function (resp) {
                        return resp['chat_room_id'] === chat_room_id;
                    });
                    if (found) {
                        found['unread_messages_count'] = unread_messages_count;
                    }
                });

                $scope.contacts_unread_messages_in_unloaded_contacts_count = $scope.total_unread_message_count;
                $.each($scope.contacts, function (contact_id, contact) {
                    $scope.contacts_unread_messages_in_unloaded_contacts_count -=
                            contact['unread_messages_count'] ? contact['unread_messages_count'] : 0;
                });
            };


            $scope.get_last_message_id = function (chatroom_id, first) {
                if (!chatroom_id || !$scope.loaded_chats[chatroom_id] || !$scope.loaded_chats[chatroom_id]['messages'].length) {
                    return null;
                }
                var msgs = $scope.loaded_chats[chatroom_id]['messages'];
                return msgs[first ? 0 : (msgs.length - 1)]['id']
            };

            $scope.get_last_message_ids = function () {
                var ret = {};
                $.each($scope.loaded_chats, function (chat_room_id) {
                    ret[chat_room_id] = $scope.get_last_message_id(chat_room_id);
                });
                return ret;
            };

            $scope.search_community = function (full_reload) {
                if ($scope.selected_messenger_menu !== 'community') {
                    return;
                }
                if (full_reload) {
                    $scope.community = [];
                    $scope.community_next_page = 1;
                    $scope.community_loading = false;
                }

                if ($scope.community_loading !== false) {
                    return;
                }

                $scope.community_loading = $scope.community_search_text;

                (function f(searched_text) {
                    $ok($scope.community_search_url(), {
                        text: searched_text,
                        page: $scope.community_next_page
                    }, function (resp) {
                        if (searched_text === $scope.community_search_text) {
                            $scope.community.push.apply($scope.community, resp['community']);
                            $scope.community_next_page = resp['next_page'];
                        }
                        $scope.community_loading = false;
                    }, function (resp) {
                        $scope.community_loading = false;
                    });
                })($scope.community_loading);
            };

            $scope.search_contacts = function (full_reload) {
                if (full_reload) {
                    $scope.contacts = [];
                    $scope.contacts_next_page = 1;
                    $scope.contacts_loading = false;
                }

                if ($scope.contacts_loading !== false) {
                    return;
                }

                $scope.contacts_loading = $scope.contacts_search_text;

                (function f(searched_text) {
                    $ok($scope.contacts_search_url(), {
                        text: searched_text,
                        page: $scope.contacts_next_page
                    }, function (resp) {
                        if (searched_text === $scope.contacts_search_text) {
                            $scope.contacts.push.apply($scope.contacts, resp['contacts'])
                            $scope.contacts_next_page = resp['next_page'];
                            $scope.contacts_loading = false;
                            if (!$scope.selected_chat_room || !$scope.contacts.find(function (resp) {
                                        return resp['chat_room_id'] === $scope.selected_chat_room['chat_room_id'];
                                    })) {
                                pr_chat_socket.emit('select_chat_room_id', null);
                                $scope.selected_chat_room = null;
                            }

                            $scope.set_unread_message_count([]);
                        }
                    }, function (resp) {
                        $scope.contacts_loading = false;
                    });
                })($scope.contacts_loading);
            };

            $scope.contact_action = function (user, action) {
                if (user.changing_contact) {
                    return false
                }
                user.changing_contact = true;
                $ok($scope.contact_action_url(), {
                    user_id: user['id'],
                    action: action
                }, function (resp) {
                    user['contact_status'] = resp['contact_status'];
                    user.changing_contact = false;
                }, function (resp) {
                    user.changing_contact = false;
                });

            };

            $scope.message_cant_be_sent = function () {
                if (!$scope.selected_chat_room) return 'please select chat to send message';
                if ($scope.selected_chat_room['loading']) return 'pls wait until chat is loading';
                if ($scope.selected_chat_room['sending_message']) return 'prev message sending is in progress';
                if ($scope.selected_chat_room['my_message'].trim() == '') return 'please type something';
                if ($scope.selected_chat_room['my_message'].length > 500) return 'message must be shorter than 500 symbols';
                return false
            };

            $scope.init_messenger = function () {

                $scope.set_selected_menu('chat');

                pr_chat_socket.removeAllListeners("set_unread_message_count");

                pr_chat_socket.on('set_unread_message_count', function (resp) {
                    angularControllerFunction('user_controller', 'set_unread_message_count')(resp['total']);
                    $scope.total_unread_message_count = resp['total'];
                    $scope.set_unread_message_count(resp);
                });

                pr_chat_socket.on('new_message', function (resp) {
{#                    $timeout(function () {#}
                        if ($scope.selected_chat_room && $scope.selected_chat_room['chat_room_id'] === resp['chat_room_id']) {
                            $scope.append_messages(resp['chat_room_id'], [resp]);
{#                            $ok('', {});#}
                        }
                        $scope.stickToBottom(resp['chat_room_id'], {'messages': [resp]}, false, false, false);
                        $scope.$digest();
{#                    }, 0);#}
                });

                pr_chat_socket.on('connect', function () {
                    if ($scope.selected_chat_room) {
                        pr_chat_socket.emit('select_chat_room_id', $scope.selected_chat_room['chat_room_id']);
                    }
                });

                $('#panel-scroll-chat').on('scroll', function () {
                    $scope.onscroll()
                });

                var elem = $('#messenger-controller textarea');


                elem.bind('keydown', function (event) {
                    var code = event.keyCode || event.which;
                    if (code == 13) {
                        if (event.ctrlKey) {
                            var elhtml = elem[0];
                            var val = elhtml.value;
                            if (typeof elhtml.selectionStart == "number" && typeof elhtml.selectionEnd == "number") {
                                var start = elhtml.selectionStart;
                                elhtml.value = val.slice(0, start) + "\n" + val.slice(elhtml.selectionEnd);
                                elhtml.selectionStart = elhtml.selectionEnd = start + 1;
                            } else if (document.selection && document.selection.createRange) {
                                elhtml.focus();
                                var range = document.selection.createRange();
                                range.text = "\r\n";
                                range.collapse(false);
                                range.select();
                            }
                        }
                        else {
                            $scope.send_message();
                        }
                        event.preventDefault();
                    }
                });
            };
        }]);
    </script>

    {% raw %}
    <div ng-controller="messenger" id="messenger-controller" ng-cloak ng-init="init_messenger()">

        <div class="container">
            <div class="row reader-list-nav menu-company">
                <div class="col-lg-12">
                    <ul>
                        <li><a ng-click="set_selected_menu('chat')" class="link"
                               ng-class="{'selected': selected_messenger_menu == 'chat'}">{{ _('Messages') }}</a>
                        </li>
                        <li><a ng-click="set_selected_menu('community')" class="link"
                               ng-class="{'selected': selected_messenger_menu == 'community'}">{{ _('Community') }}</a>
                        </li>
                        <li><a ng-click="set_selected_menu('notifications')" class="link"
                               ng-class="{'selected': selected_messenger_menu == 'notifications'}">{{ _('Notifications')
                            }}</a>
                        </li>
                    </ul>
                </div>
            </div>


            <div class="row mt1em">
                <div class="messenger-chat" ng-show="selected_messenger_menu == 'chat'">


                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 contacts-window">
                        <input ng-if="0 " placeholder="{{ _('Search in chat') }}"
                               class="form-control" type="text"
                               ng-model-options='{ debounce: 500 }'
                               ng-change="search_chat(true)" ng-model="chat_search_text"/>

                        <div class="panel">


                            <input placeholder="{{ _('Search for contact') }}"
                                   class="form-control" type="text"
                                   ng-model-options='{ debounce: 500 }'
                                   ng-change="search_contacts(true)" ng-model="contacts_search_text"/>

                            <div ng-show="contacts_loading" class="tac"><i class="fa fa-spinner fa-spin"></i>&nbsp;&nbsp;&nbsp;
                                {{ _('Loading contacts') }}
                            </div>

                            <div ng-show="!contacts_loading" class="contact-list">

                                <div ng-show="contacts_unread_messages_in_unloaded_contacts_count">{{ _('There is
                                    %(contacts_unread_messages_in_unloaded_contacts_count)s unread messages in
                                    unloaded
                                    contacts',
                                    {'contacts_unread_messages_in_unloaded_contacts_count':
                                    contacts_unread_messages_in_unloaded_contacts_count}) }}
                                </div>

                                <ul class="list-group">
                                    <a href="#" ng-click="select_chat_room(chat_room)"
                                       ng-repeat="chat_room in contacts">
                                        <li style="position: relative" class="list-group-item"
                                            ng-class="{'selected': chat_room['chat_room_id'] === selected_chat_room['chat_room_id']}">
                                            <img class="messenger-avatar" pr-image-position="center center"
                                                 pr-image-url="{{ chat_room.users[0].avatar.url }}"/>
                                            <span ng-bind-html="highlight(chat_room.users[0].full_name, $parent.contacts_search_text)"></span>
                                            <span class="unread_messages_count pa"
                                                  ng-if="chat_room.unread_messages_count">{{ chat_room.unread_messages_count }}</span>
                                        </li>

                                    </a>
                                </ul>


                                <div class="tac disabled" ng-show="!contacts.length && !contacts_search_text">{{ _('You
                                    have no contacts') }}
                                </div>
                                <div class="tac" ng-show="!contacts.length && contacts_search_text">{{ _('No contacts
                                    match
                                    search
                                    criteria') }}
                                </div>
                                <button ng-show="contacts_next_page" ng-click="search_contacts()"
                                        class="btn btn-default w100">{{ _('Load more contacts') }}
                                </button>
                            </div>


                        </div>
                    </div>

                    <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 chat-window">
                        <input ng-if="0 " placeholder="{{ _('Search in chat') }}"
                               class="form-control" type="text"
                               ng-model-options='{ debounce: 500 }'
                               ng-change="search_chat(true)" ng-model="chat_search_text"/>

                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                <i class="fa fa-comments"></i> {{ selected_chat_room?_('chat with %(names)s',
                                {'names': get_chat_interlocutors(selected_chat_room)['full_name']}):_('No chat
                                selected') }}
                            </div>

                            <div class="panel-body" id="panel-body-chat">

                                <div class="panel-scroll-chat" id="panel-scroll-chat">

                                    <div ng-if="!selected_chat_room" class="chat tac disabled">{{ _('Please select
                                        user to chat with')}}
                                    </div>


                                    <ul ng-if="selected_chat_room"
                                        class="chat-session media-block " id="panel-body-chat-messages">

                                        <li class="clearfix tac"
                                            ng-show="selected_chat_room['there_is_older'] && !selected_chat_room['loading_older_messages']">
                                            <a class="noselect" href="#" ng-click="load_messages(true)">{{ _('Load
                                                older') }}</a>
                                        </li>

                                        <li class="clearfix tac"
                                            ng-show="selected_chat_room['there_is_older'] && selected_chat_room['loading_older_messages']">
                                            <i class="fa fa-spinner fa-spin"></i>&nbsp;&nbsp;&nbsp;{{ _('Loading older
                                            messages')
                                            }}
                                        </li>

                                        <li class="clearfix"
                                            ng-show="!selected_chat_room['there_is_older'] && selected_chat_room['messages'].length">
                                            <div class="tac disabled">{{ _('There is no older messages') }}</div>
                                        </li>

                                        <li ng-show="!selected_chat_room['messages'].length && !selected_chat_room['loading_older_messages'] && !selected_chat_room['loading_newer_messages']"
                                            class="clearfix">{{ _('There is no messages in this chat') }}
                                        </li>


                                        <li ng-repeat="message in ::selected_chat_room['messages'] track by message.id"
                                            aang-class="{'right': message['from_user_id'] == me_user['id'], 'left': message['from_user_id'] != me_user['id']}"
                                            class="mar-btm">


                                            <div ng-if="message.session" class="tac red">{{ ::_('chat session started
                                                %(chat_session_start)s', {chat_session_start: moment(message.cr_tm)}) }}
                                            </div>

                                            <div class="chat-img"
                                                 ng-class="{'media-right': message['from_user_id'] == me_user['id'], 'media-left': message['from_user_id'] != me_user['id']}">
                                                <img class="messenger-avatar" pr-image-position="center center"
                                                     pr-image-url="{{ ::get_chat_interlocutors(selected_chat_room, message)['avatar']['url'] }}"/>
                                            </div>

                                            <div class="media-body pad-hor"
                                                 ng-class="{'speech-right': message['from_user_id'] == me_user['id']}">
                                                <div class="speech">
                                                    <span class="media-heading">{{ ::get_chat_interlocutors(selected_chat_room, message)['full_name'] }}</span>
                                                    <p class="speech-content">{{ ::message.content }}</p>
                                                    <p class="speech-time"><i class="fa fa-clock-o fa-fw"></i> {{ ::message.cr_tm }}</p>
                                                </div>
                                            </div>
                                        </li>


                                        <li class="clearfix tac"
                                            ng-show="selected_chat_room['there_is_newer'] && !selected_chat_room['loading_newer_messages']">
                                            <a class="noselect" href="#" ng-click="load_messages(false)">{{ _('Load
                                                newer messages')
                                                }}</a>
                                        </li>

                                        <li class="clearfix tac"
                                            ng-show="selected_chat_room['there_is_newer'] && selected_chat_room['loading_newer_messages']">
                                            <i class="fa fa-spinner fa-spin"></i>&nbsp;&nbsp;&nbsp;{{ _('Loading newer
                                            messages...')
                                            }}
                                        </li>

                                        <li class="clearfix tac"
                                            ng-show="!selected_chat_room['messages'].length && selected_chat_room['loading_newer_messages']">
                                            <i class="fa fa-spinner fa-spin"></i>&nbsp;&nbsp;&nbsp;{{ _('Loading
                                            messages...')
                                            }}
                                        </li>

                                    </ul>
                                </div>
                            </div>
                            <div class="panel-footer">
                                <div class="input-group">
                                <textarea ng-model="selected_chat_room['my_message']"
                                          id="btn-input"
                                          type="text"
                                          ng-disabled="selected_chat_room['chat_room_status'] != 'ACTIVE_ACTIVE' || !selected_chat_room || !selected_chat_room || selected_chat_room['loading']"
                                          class="form-control input-sm"
                                          placeholder="{{ _(selected_chat_room['chat_room_status'] == 'ACTIVE_ACTIVE'?'Type your message here...':'You can`t chat with this person') }}"></textarea>
                                    <span class="input-group-btn">
                            <button ng-disabled="message_cant_be_sent()"
                                    title="{{ message_cant_be_sent()?_(message_cant_be_sent()):'' }}"
                                    ng-click="send_message()"
                                    class="btn btn-info btn-sm" id="btn-chat">
                                {{ _('Send message') }}</button>
                        </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="messenger-search-community" ng-show="selected_messenger_menu == 'community'"
                     infinite-scroll="search_community()"
                     infinite-scroll-disabled="community_loading !== false || !community_next_page"
                     bak-infinite-scroll-parent="true">

                    <input placeholder="{{ _('Search user with same subscriptions or employment') }}"
                           class="form-control" type="text"
                           ng-model-options='{ debounce: 500 }'
                           ng-change="search_community(true)" ng-model="community_search_text"/>

                    <div ng-repeat="usr in community">
                        <div class="row search-community-row">
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
                                <img class="messenger-avatar" pr-image-position="center center"
                                     pr-image-url="{{ usr.avatar.url }}"/>
                                <div class="nowrap"
                                     ng-bind-html="usr.full_name | highlight: community_search_text"></div>
                                <br/>
                                <br/>
                                <button ng-disabled="usr.changing_contact"
                                        ng-show="!usr.contact_status || usr.contact_status == 'ANY_REVOKED' || usr.contact_status == 'REVOKED_ANY'"
                                        ng-click="contact_action(usr, 'add')" class="btn btn-success w15em"><i
                                        class="fa fa-plus"></i>&nbsp;&nbsp;&nbsp;{{ _('Add contact') }}
                                </button>
                                <button ng-disabled="usr.changing_contact"
                                        ng-show="usr.contact_status == 'ACTIVE_ACTIVE'"
                                        ng-click="contact_action(usr, 'remove')" class="btn btn-danger w15em"><i
                                        class="fa fa-minus"></i>&nbsp;&nbsp;&nbsp;{{ _('Remove from contacts') }}
                                </button>
                                <button ng-disabled="usr.changing_contact"
                                        ng-show="usr.contact_status == 'REQUESTED_UNCONFIRMED'"
                                        ng-click="contact_action(usr, 'revoke')" class="btn btn-warning w15em"><i
                                        class="fa fa-minus"></i>&nbsp;&nbsp;&nbsp;{{ _('Awaiting for confirmation') }}
                                </button>
                                <button ng-disabled="usr.changing_contact"
                                        ng-show="usr.contact_status == 'UNCONFIRMED_REQUESTED'"
                                        ng-click="contact_action(usr, 'confirm')" class="btn btn-info w15em"><i
                                        class="fa fa-plus"></i>&nbsp;&nbsp;&nbsp;{{ _('Confirm contact') }}
                                </button>
                                <button ng-disabled="usr.changing_contact"
                                        ng-show="usr.contact_status == 'ACTIVE_BANNED'"
                                        class="btn btn-danger w15em"><i
                                        class="fa fa-ban"></i>&nbsp;&nbsp;&nbsp;{{ _('Sorry, you are banned by this user') }}
                                </button>
                                <button ng-disabled="usr.changing_contact"
                                        ng-show="usr.contact_status == 'BANNED_ACTIVE'"
                                        ng-click="contact_action(usr, 'unban')" class="btn btn-danger w15em"><i
                                        class="fa fa-ban"></i>&nbsp;&nbsp;&nbsp;{{ _('Banned. Remove ban for this user') }}
                                </button>
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
                                <i class="fa fa-newspaper-o"></i> {{ _('Common portals subscribed') }}
                                <div class="no-common" ng-if="! usr.common_portals_subscribed.length"><i
                                        class="fa fa-minus-circle red">&nbsp;</i>{{ _('No common portal') }}
                                </div>
                                <div ng-repeat="portal in usr.common_portals_subscribed"><img
                                        class="common-portal-logo"
                                        pr-image-position="left" pr-image-url="{{ portal.logo.url }}"/><a
                                        class="external_link" href="//{{ portal.host }}" target="_blank">{{ portal.name }}<i class="fa fa-external-link ml025em"></i></a>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
                                <i class="fa fa-building-o"></i> {{ _('Common company employers') }}
                                <div class="no-common" ng-if="! usr.common_companies_employers.length"><i
                                        class="fa fa-minus-circle red">&nbsp;</i>{{ _('No common employers') }}
                                </div>
                                <div ng-repeat="company in usr.common_companies_employers"><img
                                        class="common-employer-logo"
                                        pr-image-position="left" pr-image-url="{{ company.logo.url }}"/>{{ company.name }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="label label-warning w100 tac db mt1em" ng-show="community_next_page"><i
                            class="fa fa-spinner fa-spin"></i>&nbsp;&nbsp;&nbsp;{{ _('Loading community page') }}
                    </div>
                    <div class="label label-info w100 tac db mt1em" ng-show="!community_next_page"><i
                            class="fa fa-check"></i>&nbsp;&nbsp;&nbsp;{{ _('All community users loaded') }}
                    </div>

                </div>

                <div class="messenger-notification" ng-show="selected_messenger_menu == 'notifications'">


                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 chat-window">
                        <input ng-if="0 " placeholder="{{ _('Search in chat') }}"
                               class="form-control" type="text"
                               ng-model-options='{ debounce: 500 }'
                               ng-change="search_chat(true)" ng-model="chat_search_text"/>

                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                <i class="fa fa-bullhorn"></i> {{ _('profireader system notifications') }}
                            </div>

                            <div class="panel-body" id="panel-body-chat">

                                <div class="panel-scroll-chat" id="panel-scroll-chat">

                                    <ul class="chat-session media-block " id="panel-body-chat-notifications">


                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>
    {% endraw %}
{% endblock portal_content %}
